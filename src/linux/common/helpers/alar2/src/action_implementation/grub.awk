#!/bin/awk


#
# this file is needed for RedHat 6.x distros. The grub.conf file is not regenerated by any tool
# compared to grub2. this is solved with the help of AWK and SED
# All modifications are only related to initrd. As this line is missing quite often after a kernel update
#


BEGIN {
    i=0
    kernel_version=""
}
$0 ~ /kernel|initrd/ && $0 !~ /^#|.*#/{
    grub_directive[i]=$1
    directive_value[i]=$2
    indexLine[i]=NR
    i++
 } 
    

#
# Build a substring delimited by '-' but start at the second character
#
#
function substr_c2(_i) {
	return substr(directive_value[_i],index(directive_value[_i],"-")+1)
}
 

#
# Find out whether the grub directive follow the right order or whether we have one missing (initrd)
# In that case we need to know the number of the lines in order to insert an initrd line  
#
function directiveMissing() {
	k=0
    	for (j=0; j<i; j++) {
        	k = j
        	if ( grub_directive[k] == grub_directive[k+1] ) {
			sed_modify="sed -e '" indexLine[k] "ainitrd /initramfs-" substr_c2(k) ".img'  /boot/grub/grub.conf"
			system(sed_modify)
			kernel_version = substr_c2(k)
        	}
		j++
    		}
}


#
# Find out whether the grub directiveValues for  initrd is available
# If it is empty the right value has to be inserted
#
function directiveValueMissing() {
	k=0
    	for (j=0; j<i; j++) {
        	k = j
        	if ( length(directive_value[k]) == 0 ) {
			sed_modify="sed -e '" indexLine[k] "c\tinitrd /initramfs-" substr_c2(k-1) ".img'  /boot/grub/grub.conf"
			system(sed_modify)
			kernel_version = substr_c2(k-1)
        	}
    	}
}


END { 

	directiveMissing()	
	directiveValueMissing()
	print "Starting recreate of initramfs"
	img_str="dracut -f /boot/initramfs-" substr_c2(0) ".img " substr_c2(0)
        system(img_str)
	print "Recreate of initramfs finished"
}
